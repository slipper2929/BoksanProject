<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.boksan.dao.ManagerDao">


	<resultMap type="org.boksan.model.b_deptDTO" id="b_deptDTO">
		<result property="dept_name" column="Dept_name"></result>
	</resultMap>
	
	<resultMap type="org.boksan.model.b_approveDTO" id="select_b_approveDTO">
		<result property="approve" column="Approve"></result>
	</resultMap>
	
	<resultMap type="org.boksan.model.b_empDTO" id="b_empDTO">
		<result property="emp_code" column="Emp_code"></result>
		<result property="dept_code" column="Dept_code"></result>
		<result property="socialnum" column="Socialnum"></result>
		<result property="name" column="Name"></result>
		<result property="address" column="Address"></result>
		<collection property="b_dept" resultMap="b_deptDTO"></collection>
		<collection property="b_approve" resultMap="select_b_approveDTO"></collection>
	</resultMap>
	
	
	<!-- 직원조회 -->
	<select id="emp_select" resultMap="b_empDTO">
			<if test = "keyword == null">
		select a.approve,
				e.emp_code,
				e.name,
				e.socialnum,
				e.address,
				e.dept_code,
				d.dept_name
		from(
			select @rownum:=@rownum+1 as rownum, a.*
			from (select @rownum:=0) as tmp, b_approve a	
			LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			ORDER BY e.emp_code
			) as a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			WHERE a.approve = 1
		<![CDATA[
			AND rownum > (#{pagenum} - 1 ) * #{amount} and rownum <= #{pagenum} * 20
		]]>
			
		</if>
		<if test = "keyword != null">
			select  a.approve,
					e.emp_code,
					e.name,
					e.socialnum,
					e.address,
					e.dept_code,
					d.dept_name
			from(
			select @rownum:=@rownum+1 as rownum, a.*
			from (select @rownum:=0) as tmp, b_approve a	
			LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			where e.emp_code like CONCAT('%',#{keyword},'%')
			or e.socialnum like CONCAT('%',#{keyword},'%')
			or e.name like CONCAT('%',#{keyword},'%')
			or d.dept_name like CONCAT('%',#{keyword},'%')
			order BY e.emp_code 
			) as a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code	
			WHERE a.approve = 1 
			<![CDATA[
			AND rownum > (#{pagenum}-1) * #{amount} and rownum <= #{pagenum} * 20
		]]>
					
		</if>
 	</select>
 	
 	  <!-- 페이징 처리를 위한 전체건수 직원조회 -->
 	<select id="getTotalCountEMP" resultType="int">
		<if test = "keyword == null">
	 		select count(*)
	 		FROM b_approve a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			WHERE a.approve = 1
	 	</if>
	 	<if test = "keyword != null">
		 	select count (*)
	 		FROM b_approve a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			where a.approve = 1
		 	AND (e.emp_code like CONCAT('%',#{keyword},'%')
		 	or e.socialnum like CONCAT('%',#{keyword},'%')
			or e.name like CONCAT('%',#{keyword},'%')
			or d.dept_name like CONCAT('%',#{keyword},'%'))
	 	</if>
 	</select>
 	
 	<select id="dept_selectbox" resultType="org.boksan.model.b_deptDTO">
 		SELECT *
 		FROM b_dept
 	</select>
 	
 	<!-- 직원부서수정 -->
 	<update id="emp_update" parameterType="hashMap">
 		UPDATE b_emp 
		SET dept_code = #{dept_arr}
		WHERE emp_code = #{emp_arr}
 	</update>
 	<!-- 체크된 직원삭제 -->
 	<delete id="emp_delete">
 		delete from b_emp
 		where emp_code = #{emp_code}
 	</delete>
	
	
	<resultMap type="org.boksan.model.b_deptDTO" id="approve_b_deptDTO">
		<result property="dept_name" column="Dept_name"></result>
	</resultMap>
	
	<resultMap type="org.boksan.model.b_approveDTO" id="b_approveDTO">
		<result property="approve" column="Approve"></result>
	</resultMap>
	
	<resultMap type="org.boksan.model.b_empDTO" id="approve_b_empDTO">
		<result property="emp_code" column="Emp_code"></result>
		<result property="dept_code" column="Dept_code"></result>
		<result property="socialnum" column="Socialnum"></result>
		<result property="name" column="Name"></result>
		<result property="address" column="Address"></result>
		<collection property="b_approve" resultMap="b_approveDTO"></collection>
		<collection property="b_dept" resultMap="approve_b_deptDTO"></collection>
	</resultMap>
	
 	<!-- 가입승인 -->
 	<select id="emp_approve" resultMap="approve_b_empDTO">
 		<if test = "keyword == null">
		select a.approve,
				e.emp_code,
				e.name,
				SUBSTR(e.socialnum,1,6) socialnum,
				e.address,
				e.dept_code,
				d.dept_name
		from(
			select @rownum:=@rownum+1 as rownum, a.*
			from (select @rownum:=0) as tmp, b_approve a	
			LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			ORDER BY e.emp_code
			) as a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			WHERE a.approve = 0
		<![CDATA[
			AND rownum > (#{pagenum} - 1 ) * #{amount} and rownum <= #{pagenum} * 20
		]]>
			
		</if>
		<if test = "keyword != null">
			select  a.approve,
					e.emp_code,
					e.name,
					SUBSTR(e.socialnum,1,6) socialnum,
					e.address,
					e.dept_code,
					d.dept_name
			from(
			select @rownum:=@rownum+1 as rownum, a.*
			from (select @rownum:=0) as tmp, b_approve a	
			LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			where e.emp_code like CONCAT('%',#{keyword},'%')
			or e.socialnum like CONCAT('%',#{keyword},'%')
			or e.name like CONCAT('%',#{keyword},'%')
			or d.dept_name like CONCAT('%',#{keyword},'%')
			order BY e.emp_code 
			) as a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code	
			WHERE a.approve = 0
			<![CDATA[
			AND rownum > (#{pagenum}-1) * #{amount} and rownum <= #{pagenum} * 20
		]]>
					
		</if>
 	</select>
 	
 	  <!-- 페이징 처리를 위한 전체건수 직원조회 -->
 	<select id="getTotalCountAP" resultType="int">
		<if test = "keyword == null">
	 		select count(*)
	 		FROM b_approve a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			WHERE a.approve = 0
	 	</if>
	 	<if test = "keyword != null">
		 	select count (*)
	 		FROM b_approve a LEFT JOIN b_emp e
			ON a.emp_code = e.emp_code
			LEFT JOIN b_dept d
			ON e.dept_code = d.dept_code
			where a.approve = 0
		 	AND (e.emp_code like CONCAT('%',#{keyword},'%')
		 	or e.socialnum like CONCAT('%',#{keyword},'%')
			or e.name like CONCAT('%',#{keyword},'%')
			or d.dept_name like CONCAT('%',#{keyword},'%'))
	 	</if>
 	</select>
 	
 	<!-- 가입승인 부서 selectbox -->
 	<select id="emp_apdept" resultType="org.boksan.model.b_deptDTO">
 		select * from b_dept
 	</select>
 	
 	<!-- 가입승인 -->
 	<update id="manager_approve">
 		UPDATE b_approve 
 		set approve = 1
 		WHERE emp_code = #{emp_code}
 	</update>
 	
 	<!-- 가입승인시 부서코드선택 -->
 	<update id="manager_dept_code">
 	UPDATE b_emp
 	set dept_code = #{dept_code}
 	WHERE emp_code = #{emp_code}
 	</update>
 	
 	<!-- 부서등록 -->
 	<insert id ="dept_group_add">
 		INSERT INTO b_dept
		SELECT (MAX(dept_code)+1) AS dept_code,
		#{dept_name} AS dept_name
		FROM b_dept
 	</insert>
 	
 	<!-- 창고등록화면 -->
 	<select id="manager_house_add" resultType="org.boksan.model.house_functionDTO">
 		SELECT * 
 		FROM house_function
 	</select>
 	
 	<resultMap type="org.boksan.model.house_functionDTO" id="house_functionDTO">
 		<result property="function_name" column="Function_name"></result>
 	</resultMap>
 	
 	<resultMap type="org.boksan.model.b_houseDTO" id="b_houseDTO">
 		<result property="house_code" column="House_code"></result>
 		<result property="house_function" column="House_function"></result>
 		<result property="out_num" column="Out_num"></result>
 		<result property="in_num" column="In_num"></result>
 		<result property="detail_position" column="Detail_position"></result>
 		<collection property="house_functiondto" column="House_function"></collection>
 	</resultMap>
 	<!-- 창고등록 -->
 	<insert id="manager_house_add">
 		
 	</insert>
 	
 	
</mapper>